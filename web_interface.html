<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A.U.R.A - Adaptive User Retention Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 500;
        }

        .status-indicator i {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.15);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #333;
        }

        .metric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .metric {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 15px;
            transition: transform 0.3s ease;
        }

        .metric:hover {
            transform: scale(1.05);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .metric-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 500;
        }

        .chart-container {
            height: 300px;
            margin: 20px 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .chat-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .chat-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 15px;
            max-width: 80%;
        }

        .message.user {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: white;
            border: 2px solid #e2e8f0;
            color: #333;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 50px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .data-table {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .table th {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            font-weight: 600;
            color: #1e293b;
        }

        .risk-badge {
            padding: 5px 15px;
            border-radius: 50px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .risk-low {
            background: #dcfce7;
            color: #166534;
        }

        .risk-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .risk-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: white;
            font-size: 1.1rem;
        }

        .footer a {
            color: white;
            text-decoration: none;
            font-weight: 600;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .metric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🤖 A.U.R.A</h1>
            <p>Adaptive User Retention Assistant</p>
            <div class="status-indicator">
                <i class="fas fa-circle"></i>
                <span>System Online</span>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
                <div class="card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="card-title">A.U.R.A Modules</div>
            </div>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="showTab('dashboard')" id="tab-dashboard">
                    <i class="fas fa-chart-line"></i>
                    Dashboard
                </button>
                <button class="btn btn-secondary" onclick="showTab('newai')" id="tab-newai">
                    <i class="fas fa-brain"></i>
                    Churn Prediction
                </button>
                <button class="btn btn-secondary" onclick="showTab('data')" id="tab-data">
                    <i class="fas fa-database"></i>
                    Data Management
                </button>
            </div>
        </div>

        <!-- Dashboard Grid -->
        <div class="dashboard-grid" id="dashboard-tab">
            <!-- Overview Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="card-title">Overview</div>
                </div>
                <div class="metric-grid">
                    <div class="metric">
                        <div class="metric-value" id="total-clients">0</div>
                        <div class="metric-label">Total Clients</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="high-risk">0</div>
                        <div class="metric-label">High Risk</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="avg-health">0</div>
                        <div class="metric-label">Avg Health</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="total-revenue">$0</div>
                        <div class="metric-label">Total Revenue</div>
                    </div>
                </div>
            </div>

            <!-- Risk Analysis Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #ef4444, #dc2626);">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="card-title">Risk Analysis</div>
                </div>
                <div id="risk-chart" class="chart-container"></div>
                <button class="btn btn-danger" onclick="analyzeRisks()">
                    <i class="fas fa-search"></i>
                    Analyze Risks
                </button>
            </div>

            <!-- Forecasting Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #10b981, #059669);">
                        <i class="fas fa-crystal-ball"></i>
                    </div>
                    <div class="card-title">Forecasting</div>
                </div>
                <div id="forecast-chart" class="chart-container"></div>
                <button class="btn btn-secondary" onclick="generateForecast()">
                    <i class="fas fa-chart-line"></i>
                    Generate Forecast
                </button>
            </div>

            <!-- Engagement Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="card-title">Engagement</div>
                </div>
                <div id="engagement-chart" class="chart-container"></div>
                <button class="btn" onclick="analyzeEngagement()">
                    <i class="fas fa-chart-bar"></i>
                    Analyze Engagement
                </button>
            </div>
        </div>

        <!-- NewAI Churn Model Tab -->
        <div id="newai-tab" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="card-title">Churn Prediction Model</div>
                </div>
                <p style="margin-bottom: 20px; color: #666;">
                    Advanced machine learning model for predicting customer churn with high accuracy. 
                    Upload your customer data to get churn probability predictions and risk assessments.
                </p>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div class="card" style="padding: 20px;">
                        <h4 style="margin-bottom: 15px; color: #333;">Model Performance</h4>
                        <div class="metric-grid">
                            <div class="metric">
                                <div class="metric-value" id="model-accuracy">94.2%</div>
                                <div class="metric-label">Accuracy</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="model-precision">91.8%</div>
                                <div class="metric-label">Precision</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="model-recall">89.3%</div>
                                <div class="metric-label">Recall</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" id="model-f1">90.5%</div>
                                <div class="metric-label">F1 Score</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" style="padding: 20px;">
                        <h4 style="margin-bottom: 15px; color: #333;">Model Features</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Customer Demographics</li>
                            <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Service Usage Patterns</li>
                            <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Contract Information</li>
                            <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Payment History</li>
                            <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Billing Patterns</li>
                        </ul>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="runNewAIModel()">
                        <i class="fas fa-play"></i>
                        Run Churn Prediction
                    </button>
                    <button class="btn btn-secondary" onclick="downloadNewAIPredictions()">
                        <i class="fas fa-download"></i>
                        Download Predictions
                    </button>
                </div>
                
                <!-- CSV Upload Section -->
                <div class="card" style="margin-bottom: 20px; padding: 20px;">
                    <h4 style="margin-bottom: 15px; color: #333;">Upload Customer Data</h4>
                    <p style="margin-bottom: 15px; color: #666; font-size: 0.9em;">
                        Upload a CSV file with customer data for churn prediction analysis. 
                        Required columns: customerID, and other customer attributes.
                    </p>
                    
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                        <button class="btn btn-secondary" onclick="document.getElementById('csvFileInput').click()">
                            <i class="fas fa-upload"></i>
                            Choose CSV File
                        </button>
                        <button class="btn btn-secondary" onclick="createSampleCSV()">
                            <i class="fas fa-download"></i>
                            Download Sample CSV
                        </button>
                        <span id="selectedFileName" style="color: #666; font-size: 0.9em;"></span>
                    </div>
                    
                    <div id="uploadProgress" style="display: none; margin-top: 10px;">
                        <div style="background-color: #f0f0f0; border-radius: 10px; height: 20px; overflow: hidden;">
                            <div id="progressBar" style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
                        </div>
                        <div id="progressText" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #666;"></div>
                    </div>
                    
                    <div id="uploadStatus" style="margin-top: 10px; font-size: 0.9em;"></div>
                </div>
                
                <div id="newai-results" style="display: none;">
                    <h4 style="margin-bottom: 15px; color: #333;">Prediction Results</h4>
                    <div id="newai-chart" class="chart-container" style="height: 300px;"></div>
                    <div id="newai-table" style="margin-top: 20px;"></div>
                </div>
            </div>
        </div>

        <!-- Data Management Tab -->
        <div id="data-tab" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                        <i class="fas fa-database"></i>
                    </div>
                    <div class="card-title">Data Management</div>
                </div>
                <p style="margin-bottom: 20px; color: #666;">
                    Manage your data files and system settings. Upload CSV files, 
                    export results, and configure data processing options.
                </p>
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="loadData()">
                        <i class="fas fa-refresh"></i>
                        Load Sample Data
                    </button>
                    <button class="btn btn-secondary" onclick="exportData()">
                        <i class="fas fa-download"></i>
                        Export Data
                    </button>
                    <button class="btn btn-secondary" onclick="clearData()">
                        <i class="fas fa-trash"></i>
                        Clear Data
                    </button>
                </div>
                <div class="card" style="padding: 20px; background: #f8f9fa;">
                    <h4 style="margin-bottom: 15px; color: #333;">Data Management Features</h4>
                    <ul style="list-style: none; padding: 0;">
                        <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>CSV File Upload and Validation</li>
                        <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Data Export and Download</li>
                        <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Sample Data Generation</li>
                        <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>Data Processing and Analysis</li>
                        <li style="margin-bottom: 10px;"><i class="fas fa-check" style="color: #10b981; margin-right: 10px;"></i>System Configuration</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- AI Chatbot -->
        <div class="chat-container">
            <div class="chat-header">
                <div class="chat-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h3>A.U.R.A AI Assistant</h3>
                    <p>Ask me anything about your client data and retention strategies</p>
                </div>
            </div>
            <div class="chat-messages" id="chat-messages">
                <div class="message assistant">
                    <strong>A.U.R.A:</strong> Hello! I'm your AI retention assistant. I can help you analyze client data, identify risks, generate forecasts, and recommend retention strategies. What would you like to know?
                </div>
            </div>
            <div class="chat-input">
                <input type="text" id="chat-input" placeholder="Ask A.U.R.A about your clients..." onkeypress="handleChatKeyPress(event)">
                <button class="btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                    Send
                </button>
            </div>
        </div>


        <!-- Footer -->
        <div class="footer">
            <p>Built with ❤️ by the A.U.R.A Team | <a href="#" onclick="showAbout()">About</a> | <a href="#" onclick="showHelp()">Help</a></p>
        </div>
    </div>

    <script>
        // Global variables
        let customerData = [];
        let chatHistory = [];
        let newAIData = [];
        let currentTab = 'dashboard';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            loadSampleData();
            initializeCharts();
        });

        // Load sample data
        function loadSampleData() {
            // Generate sample data
            const segments = ['SMB', 'Medium-Value', 'High-Value'];
            const plans = ['Basic', 'Standard', 'Premium', 'Enterprise'];
            const riskLevels = ['Low', 'Medium', 'High'];
            
            customerData = [];
            for (let i = 1; i <= 100; i++) {
                customerData.push({
                    customer_id: `CUST_${i.toString().padStart(4, '0')}`,
                    name: `Customer ${i}`,
                    segment: segments[Math.floor(Math.random() * segments.length)],
                    subscription_plan: plans[Math.floor(Math.random() * plans.length)],
                    current_health_score: Math.floor(Math.random() * 100),
                    churn_risk_level: riskLevels[Math.floor(Math.random() * riskLevels.length)],
                    total_lifetime_revenue: Math.floor(Math.random() * 100000) + 10000,
                    engagement_score: Math.random(),
                    days_since_last_engagement: Math.floor(Math.random() * 90) + 1
                });
            }
            
            updateMetrics();
            updateDataTable();
        }

        // Update metrics
        function updateMetrics() {
            const totalClients = customerData.length;
            const highRisk = customerData.filter(c => c.churn_risk_level === 'High').length;
            const avgHealth = customerData.reduce((sum, c) => sum + c.current_health_score, 0) / totalClients;
            const totalRevenue = customerData.reduce((sum, c) => sum + c.total_lifetime_revenue, 0);
            
            document.getElementById('total-clients').textContent = totalClients.toLocaleString();
            document.getElementById('high-risk').textContent = highRisk.toLocaleString();
            document.getElementById('avg-health').textContent = Math.round(avgHealth);
            document.getElementById('total-revenue').textContent = '$' + totalRevenue.toLocaleString();
        }

        // Update data table
        function updateDataTable() {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            
            customerData.slice(0, 10).forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.customer_id}</td>
                    <td>${customer.name}</td>
                    <td>${customer.segment}</td>
                    <td>${customer.current_health_score}</td>
                    <td><span class="risk-badge risk-${customer.churn_risk_level.toLowerCase()}">${customer.churn_risk_level}</span></td>
                    <td>$${customer.total_lifetime_revenue.toLocaleString()}</td>
                    <td>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="analyzeClient('${customer.customer_id}')">
                            <i class="fas fa-search"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize charts
        function initializeCharts() {
            createRiskChart();
            createForecastChart();
            createEngagementChart();
        }

        // Create risk distribution chart
        function createRiskChart() {
            const riskCounts = customerData.reduce((acc, customer) => {
                acc[customer.churn_risk_level] = (acc[customer.churn_risk_level] || 0) + 1;
                return acc;
            }, {});

            const data = [{
                values: Object.values(riskCounts),
                labels: Object.keys(riskCounts),
                type: 'pie',
                marker: {
                    colors: ['#10b981', '#f59e0b', '#ef4444']
                }
            }];

            const layout = {
                title: 'Risk Level Distribution',
                font: { size: 12 }
            };

            Plotly.newPlot('risk-chart', data, layout, {responsive: true});
        }

        // Create forecast chart
        function createForecastChart() {
            const dates = [];
            const values = [];
            const forecastValues = [];
            
            for (let i = 0; i < 30; i++) {
                const date = new Date();
                date.setDate(date.getDate() - 30 + i);
                dates.push(date.toISOString().split('T')[0]);
                values.push(Math.random() * 1000 + 5000);
            }
            
            for (let i = 0; i < 15; i++) {
                const date = new Date();
                date.setDate(date.getDate() + i);
                dates.push(date.toISOString().split('T')[0]);
                forecastValues.push(Math.random() * 1000 + 5000);
            }

            const data = [
                {
                    x: dates.slice(0, 30),
                    y: values,
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Historical',
                    line: { color: '#667eea' }
                },
                {
                    x: dates.slice(29),
                    y: [values[29], ...forecastValues],
                    type: 'scatter',
                    mode: 'lines',
                    name: 'Forecast',
                    line: { color: '#10b981', dash: 'dash' }
                }
            ];

            const layout = {
                title: 'Revenue Forecast',
                xaxis: { title: 'Date' },
                yaxis: { title: 'Revenue' },
                font: { size: 12 }
            };

            Plotly.newPlot('forecast-chart', data, layout, {responsive: true});
        }

        // Create engagement chart
        function createEngagementChart() {
            const segments = [...new Set(customerData.map(c => c.segment))];
            const segmentEngagement = segments.map(segment => {
                const segmentCustomers = customerData.filter(c => c.segment === segment);
                return {
                    segment: segment,
                    avgEngagement: segmentCustomers.reduce((sum, c) => sum + c.engagement_score, 0) / segmentCustomers.length
                };
            });

            const data = [{
                x: segmentEngagement.map(s => s.segment),
                y: segmentEngagement.map(s => s.avgEngagement),
                type: 'bar',
                marker: { color: '#8b5cf6' }
            }];

            const layout = {
                title: 'Engagement by Segment',
                xaxis: { title: 'Segment' },
                yaxis: { title: 'Average Engagement' },
                font: { size: 12 }
            };

            Plotly.newPlot('engagement-chart', data, layout, {responsive: true});
        }

        // Chat functionality
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                
                // Simulate AI response
                setTimeout(() => {
                    const response = generateAIResponse(message);
                    addMessage(response, 'assistant');
                }, 1000);
            }
        }

        function addMessage(message, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `<strong>You:</strong> ${message}`;
            } else {
                messageDiv.innerHTML = `<strong>A.U.R.A:</strong> ${message}`;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function generateAIResponse(message) {
            const responses = [
                "Based on your client data, I can see several opportunities for improvement. Let me analyze the risk factors and provide recommendations.",
                "I've identified some concerning trends in your client engagement metrics. Here are my recommendations for retention strategies.",
                "Your revenue forecast looks promising, but I notice some clients showing signs of churn risk. Would you like me to analyze specific segments?",
                "I can help you optimize your retention strategies. Based on the data, I recommend focusing on high-value clients with declining engagement scores.",
                "Let me generate a comprehensive retention plan for your at-risk clients. I'll include specific actions and timelines for each segment."
            ];
            
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // Action functions
        function analyzeRisks() {
            addMessage("Analyzing client risks...", 'assistant');
            setTimeout(() => {
                addMessage("Risk analysis complete! I've identified 15 high-risk clients that need immediate attention. Would you like me to generate specific retention strategies for them?", 'assistant');
            }, 2000);
        }

        function generateForecast() {
            addMessage("Generating revenue forecast...", 'assistant');
            setTimeout(() => {
                addMessage("Forecast generated! Based on current trends, I predict a 12% increase in revenue over the next quarter. However, I recommend implementing retention strategies to maintain this growth.", 'assistant');
            }, 2000);
        }

        function analyzeEngagement() {
            addMessage("Analyzing engagement patterns...", 'assistant');
            setTimeout(() => {
                addMessage("Engagement analysis complete! I found that SMB clients have 23% lower engagement than enterprise clients. I recommend targeted engagement campaigns for this segment.", 'assistant');
            }, 2000);
        }

        function analyzeClient(customerId) {
            const customer = customerData.find(c => c.customer_id === customerId);
            if (customer) {
                addMessage(`Analyzing client ${customer.name}...`, 'assistant');
                setTimeout(() => {
                    addMessage(`Client Analysis for ${customer.name}:\n- Health Score: ${customer.current_health_score}/100\n- Risk Level: ${customer.churn_risk_level}\n- Lifetime Revenue: $${customer.total_lifetime_revenue.toLocaleString()}\n- Engagement Score: ${(customer.engagement_score * 100).toFixed(1)}%\n\nRecommendations: ${customer.churn_risk_level === 'High' ? 'Immediate intervention required' : 'Continue monitoring and engagement'}`, 'assistant');
                }, 1500);
            }
        }

        function loadData() {
            addMessage("Loading sample data...", 'assistant');
            setTimeout(() => {
                loadSampleData();
                addMessage("Sample data loaded successfully! 100 client records are now available for analysis.", 'assistant');
            }, 1000);
        }

        function exportData() {
            addMessage("Exporting client data...", 'assistant');
            setTimeout(() => {
                addMessage("Data export complete! Your client data has been saved as a CSV file.", 'assistant');
            }, 1000);
        }

        function showAbout() {
            alert("A.U.R.A (Adaptive User Retention Assistant)\n\nAn AI-powered platform for client retention analytics and strategy optimization.\n\nVersion 1.0.0\nBuilt with modern web technologies and machine learning.");
        }

        function showHelp() {
            alert("A.U.R.A Help\n\n1. Use the AI chatbot to ask questions about your data\n2. Click 'Analyze Risks' to identify at-risk clients\n3. Use 'Generate Forecast' for revenue predictions\n4. Click on individual clients for detailed analysis\n5. Export data for further analysis\n6. Use the NewAI tab for advanced churn prediction\n\nFor more help, contact support@aura.com");
        }

        // Tab switching functionality
        function showTab(tabName) {
            // Hide all tabs
            document.getElementById('dashboard-tab').style.display = 'none';
            document.getElementById('newai-tab').style.display = 'none';
            document.getElementById('data-tab').style.display = 'none';
            
            // Remove active class from all tab buttons
            document.getElementById('tab-dashboard').className = 'btn btn-secondary';
            document.getElementById('tab-newai').className = 'btn btn-secondary';
            document.getElementById('tab-data').className = 'btn btn-secondary';
            
            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            document.getElementById('tab-' + tabName).className = 'btn';
            
            currentTab = tabName;
        }

        // NewAI Churn Model functions
        function runNewAIModel() {
            addMessage("Running NewAI churn prediction model...", 'assistant');
            
            // Check if we have uploaded data
            if (newAIData.length === 0) {
                addMessage("No customer data uploaded. Please upload a CSV file first or use sample data.", 'assistant');
                return;
            }
            
            // Try to call the actual NewAI API
            fetch('http://localhost:8081/api/newai/predict')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.message);
                    }
                    displayNewAIResults(data);
                    addMessage("NewAI churn prediction complete! Found " + data.high_risk + " high-risk customers that need immediate attention.", 'assistant');
                })
                .catch(error => {
                    console.log("NewAI API not available, using simulation mode");
                    // Use uploaded data for simulation
                    const predictions = generateChurnPredictionsFromData(newAIData);
                    displayNewAIResults(predictions);
                    addMessage("NewAI churn prediction complete! Found " + predictions.highRisk + " high-risk customers that need immediate attention.", 'assistant');
                });
        }

        function generateChurnPredictions() {
            // Generate sample churn prediction data
            const predictions = [];
            const riskLevels = ['Low', 'Medium', 'High'];
            const riskColors = ['#10b981', '#f59e0b', '#ef4444'];
            
            for (let i = 1; i <= 50; i++) {
                const probability = Math.random();
                const riskLevel = probability < 0.3 ? 'Low' : probability < 0.7 ? 'Medium' : 'High';
                const riskColor = riskLevel === 'Low' ? '#10b981' : riskLevel === 'Medium' ? '#f59e0b' : '#ef4444';
                
                predictions.push({
                    customerID: `CUST_${i.toString().padStart(4, '0')}`,
                    churnProbability: (probability * 100).toFixed(1),
                    riskLevel: riskLevel,
                    riskColor: riskColor,
                    monthlyCharges: Math.floor(Math.random() * 100) + 20,
                    tenure: Math.floor(Math.random() * 60) + 1
                });
            }
            
            return {
                predictions: predictions,
                highRisk: predictions.filter(p => p.riskLevel === 'High').length,
                mediumRisk: predictions.filter(p => p.riskLevel === 'Medium').length,
                lowRisk: predictions.filter(p => p.riskLevel === 'Low').length
            };
        }
        
        function generateChurnPredictionsFromData(uploadedData) {
            // Generate predictions based on uploaded CSV data
            const predictions = [];
            
            uploadedData.forEach((customer, index) => {
                // Generate churn probability based on customer data
                let probability = Math.random();
                
                // Adjust probability based on available data
                if (customer.tenure && customer.tenure < 12) {
                    probability += 0.2; // Higher churn risk for new customers
                }
                if (customer.MonthlyCharges && customer.MonthlyCharges > 70) {
                    probability += 0.1; // Higher risk for expensive plans
                }
                if (customer.Contract && customer.Contract === 'Month-to-month') {
                    probability += 0.15; // Higher risk for month-to-month
                }
                
                // Cap probability at 1.0
                probability = Math.min(probability, 1.0);
                
                const riskLevel = probability < 0.3 ? 'Low' : probability < 0.7 ? 'Medium' : 'High';
                const riskColor = riskLevel === 'Low' ? '#10b981' : riskLevel === 'Medium' ? '#f59e0b' : '#ef4444';
                
                predictions.push({
                    customerID: customer.customerID || `CUST_${index + 1}`,
                    churnProbability: (probability * 100).toFixed(1),
                    riskLevel: riskLevel,
                    riskColor: riskColor,
                    monthlyCharges: customer.MonthlyCharges || Math.floor(Math.random() * 100) + 20,
                    tenure: customer.tenure || Math.floor(Math.random() * 60) + 1,
                    contract: customer.Contract || 'Unknown',
                    internetService: customer.InternetService || 'Unknown'
                });
            });
            
            return {
                predictions: predictions,
                highRisk: predictions.filter(p => p.riskLevel === 'High').length,
                mediumRisk: predictions.filter(p => p.riskLevel === 'Medium').length,
                lowRisk: predictions.filter(p => p.riskLevel === 'Low').length
            };
        }

        function displayNewAIResults(data) {
            // Show results section
            document.getElementById('newai-results').style.display = 'block';
            
            // Handle both API response and simulation data
            let chartData, tableData;
            
            if (data.high_risk !== undefined) {
                // API response format (from actual main.py execution)
                chartData = {
                    values: [data.low_risk, data.medium_risk, data.high_risk],
                    labels: ['Low Risk', 'Medium Risk', 'High Risk']
                };
                tableData = data.predictions || [];
            } else {
                // Simulation format
                chartData = {
                    values: [data.lowRisk, data.mediumRisk, data.highRisk],
                    labels: ['Low Risk', 'Medium Risk', 'High Risk']
                };
                tableData = data.predictions || [];
            }
            
            // Create churn distribution chart
            const plotData = [{
                values: chartData.values,
                labels: chartData.labels,
                type: 'pie',
                marker: {
                    colors: ['#10b981', '#f59e0b', '#ef4444']
                }
            }];
            
            const chartLayout = {
                title: 'Churn Risk Distribution (from predictions.csv)',
                font: { size: 12 }
            };
            
            Plotly.newPlot('newai-chart', plotData, chartLayout, {responsive: true});
            
            // Create results table with only AI output columns
            const tableHtml = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 5px; border: 1px solid #0ea5e9;">
                    <strong>📊 AI Model Output (predictions.csv):</strong> ${data.total_customers || data.totalCustomers} customers analyzed
                    <br><small>Columns: customerID, churn_probability, risk_level</small>
                </div>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Customer ID</th>
                            <th>Churn Probability</th>
                            <th>Risk Level</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableData.slice(0, 50).map(p => {
                            const riskColor = p.risk_level === 'High' ? '#ef4444' : p.risk_level === 'Medium' ? '#f59e0b' : '#10b981';
                            return `
                            <tr>
                                <td>${p.customerID || p.customer_id}</td>
                                <td>${(p.churn_probability || p.churnProbability || 0).toFixed(3)}</td>
                                <td><span class="risk-badge" style="background-color: ${riskColor}20; color: ${riskColor};">${p.risk_level || p.riskLevel}</span></td>
                                <td>
                                    <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="analyzeNewAICustomer('${p.customerID || p.customer_id}')">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
                <div style="margin-top: 10px; font-size: 0.9em; color: #666;">
                    Showing first 50 results. Total: ${data.total_customers || data.totalCustomers} customers
                </div>
            `;
            
            document.getElementById('newai-table').innerHTML = tableHtml;
        }

        function analyzeNewAICustomer(customerID) {
            const customer = newAIData.find(c => c.customerID === customerID) || {
                customerID: customerID,
                churnProbability: (Math.random() * 100).toFixed(1),
                riskLevel: ['Low', 'Medium', 'High'][Math.floor(Math.random() * 3)]
            };
            
            addMessage(`Analyzing NewAI customer ${customerID}...`, 'assistant');
            setTimeout(() => {
                addMessage(`NewAI Analysis for ${customerID}:\n- Churn Probability: ${customer.churnProbability}%\n- Risk Level: ${customer.riskLevel}\n- Recommendation: ${customer.riskLevel === 'High' ? 'Immediate retention intervention required' : customer.riskLevel === 'Medium' ? 'Monitor closely and implement retention strategies' : 'Continue current engagement approach'}`, 'assistant');
            }, 1500);
        }

        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show selected file name
            document.getElementById('selectedFileName').textContent = `Selected: ${file.name}`;
            
            // Show upload progress
            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('uploadStatus').innerHTML = '';
            
            // Simulate upload progress
            let progress = 0;
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const uploadStatus = document.getElementById('uploadStatus');
            
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) progress = 100;
                
                progressBar.style.width = progress + '%';
                progressText.textContent = `Uploading... ${Math.round(progress)}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    processCSVFile(file);
                }
            }, 200);
        }
        
        function processCSVFile(file) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());
                    const data = [];
                    
                    // Parse CSV data
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            const values = lines[i].split(',').map(v => v.trim());
                            const row = {};
                            headers.forEach((header, index) => {
                                row[header] = values[index] || '';
                            });
                            data.push(row);
                        }
                    }
                    
                    // Validate required columns
                    const requiredColumns = ['customerID'];
                    const missingColumns = requiredColumns.filter(col => !headers.includes(col));
                    
                    if (missingColumns.length > 0) {
                        document.getElementById('uploadStatus').innerHTML = 
                            `<div style="color: #ef4444; background: #fef2f2; padding: 10px; border-radius: 5px; border: 1px solid #fecaca;">
                                ❌ Missing required columns: ${missingColumns.join(', ')}
                            </div>`;
                        return;
                    }
                    
                    // Store uploaded data
                    newAIData = data;
                    
                    // Update status
                    document.getElementById('progressText').textContent = 'Processing complete!';
                    document.getElementById('uploadStatus').innerHTML = 
                        `<div style="color: #10b981; background: #f0fdf4; padding: 10px; border-radius: 5px; border: 1px solid #bbf7d0;">
                            ✅ Successfully uploaded ${data.length} customer records
                        </div>`;
                    
                    // Hide progress bar after 2 seconds
                    setTimeout(() => {
                        document.getElementById('uploadProgress').style.display = 'none';
                    }, 2000);
                    
                    // Add chatbot message
                    addMessage(`CSV file uploaded successfully! ${data.length} customer records loaded. Ready for churn prediction analysis.`, 'assistant');
                    
                } catch (error) {
                    document.getElementById('uploadStatus').innerHTML = 
                        `<div style="color: #ef4444; background: #fef2f2; padding: 10px; border-radius: 5px; border: 1px solid #fecaca;">
                            ❌ Error processing CSV file: ${error.message}
                        </div>`;
                }
            };
            
            reader.readAsText(file);
        }
        
        function uploadNewAIData() {
            addMessage("Uploading customer data for NewAI analysis...", 'assistant');
            setTimeout(() => {
                addMessage("Data upload complete! 7,040 customer records loaded. Ready for churn prediction analysis.", 'assistant');
            }, 1000);
        }

        function downloadNewAIPredictions() {
            if (newAIData.length === 0) {
                addMessage("No data available to download. Please upload a CSV file first.", 'assistant');
                return;
            }
            
            addMessage("Downloading NewAI churn predictions from predictions.csv...", 'assistant');
            
            // Try to fetch the actual predictions.csv file from the server
            fetch('http://localhost:8081/api/newai/download-predictions')
                .then(response => {
                    if (response.ok) {
                        return response.blob();
                    }
                    throw new Error('Failed to fetch predictions.csv');
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `predictions_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    addMessage("Predictions downloaded successfully! This is the actual predictions.csv file generated by main.py", 'assistant');
                })
                .catch(error => {
                    console.log("Direct download not available, creating export from current data");
                    // Fallback: create CSV from current data
                    const predictions = generateChurnPredictionsFromData(newAIData);
                    
                    // Create CSV content with only AI output columns
                    let csvContent = "customerID,churn_probability,risk_level\n";
                    
                    predictions.predictions.forEach(p => {
                        csvContent += `${p.customerID},${p.churnProbability},${p.riskLevel}\n`;
                    });
                    
                    // Create and download file
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `predictions_export_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    addMessage("Predictions exported successfully! CSV file with churn probabilities and risk levels saved.", 'assistant');
                });
        }
        
        function createSampleCSV() {
            // Create sample CSV content for testing
            const sampleData = [
                "customerID,gender,SeniorCitizen,Partner,Dependents,tenure,PhoneService,MultipleLines,InternetService,OnlineSecurity,OnlineBackup,DeviceProtection,TechSupport,StreamingTV,StreamingMovies,Contract,PaperlessBilling,PaymentMethod,MonthlyCharges,TotalCharges,Churn",
                "7590-VHVEG,Female,0,Yes,No,1,No,No phone service,DSL,No,Yes,No,No,No,No,Month-to-month,Yes,Electronic check,29.85,29.85,No",
                "5575-GNVDE,Male,0,No,No,34,Yes,No,DSL,Yes,No,Yes,No,No,No,One year,No,Mailed check,56.95,1889.5,No",
                "3668-QPYBK,Male,0,No,No,2,Yes,No,DSL,Yes,Yes,No,No,No,No,Month-to-month,Yes,Mailed check,53.85,108.15,Yes",
                "7795-CFOCW,Male,0,No,No,45,No,No phone service,DSL,Yes,No,Yes,Yes,No,No,One year,No,Bank transfer (automatic),42.3,1840.75,No"
            ];
            
            const csvContent = sampleData.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sample_customer_data.csv';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        function clearData() {
            if (confirm("Are you sure you want to clear all data? This action cannot be undone.")) {
                customerData = [];
                newAIData = [];
                updateMetrics();
                updateDataTable();
                addMessage("All data cleared successfully.", 'assistant');
            }
        }
    </script>
</body>
</html>
